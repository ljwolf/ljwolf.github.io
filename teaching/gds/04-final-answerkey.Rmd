---
title: "Wining and Dining: Data Science Edition"
output:   
  tufte::tufte_html: default
  tufte::tufte_handout: default
---

Your friend from school has just returned from their gap year as a [WWOOF-er](https://wwoof.org.uk/) in a small estate outside of Lyon. They claim that there's nothing quite like a French wine. They're better, more expensive, and they won't let you forget it! 

But, you have your doubts: 

> *Are French wines really the best, or are they just more expensive for the same quality?*

So you, now a freshly minted data scientist, decide to moonlight as a data sommelier. Your overarching mission: shed some light on this question. 

# 0 The Data

You find a nice dataset of [all the wine ratings](https://www.kaggle.com/zynicide/wine-reviews) from *WineMag*, a lifestyle magazine about wine & winemaking, and get to work. 

```{r message=F, warning=F}
library(tidyverse)
wines = read_csv('http://ljwolf.org/teaching/gds/wines.csv')
wines %>% head(1) %>% knitr::kable()
```

As you can see, the data contains information on the `country` the wine is from, as well as the `province`, the macro-level `region` (which is below the `province`) and the micro-level `region_2` (which is below the `region_1`). The `designation` represents the part of the vinyard where the vintner claims the wine comes from. The `price` is the price (in dollars) of the wine. The `points` are the rating of the wine, given by *WineMag*'s judges. Finally, the `variety` reflects the grape (or grapes) used to make the wine, and the `winery` reflects the name of the winery that grew the wine. 

# 1 Exploration & Visualization

This section, please use tidy transformation, like `group_by` and `summarize`, to obtain the answers to these questions. 

## 1.1 

What is your best guess about the price and rating of wines from each country? 

```{r}
wines %>% group_by(country) %>% summarize(price = mean(price), rating=mean(points))
```

## 1.2

What is the highest rating attained by a wine in each country?

```{r}
wines %>% group_by(country) %>% arrange(desc(points)) %>% summarize(first(points))
```

## 1.3 

Using `ggplot`, show me the distribution of the ratings of wines in each country. 

```{r}
wines %>% ggplot(aes(x=points, y=country, fill=country)) + geom_violin(draw_quantiles = c(.25,.5,.75), adjust=1.5)
```

## 1.4

[Orson Welles disagrees with your friend, and thinks that the US is almost as good as France at making champagne...but he was paid a lot (in free US wine) to say so!](https://www.youtube.com/watch?v=Nvxwf1jxdaM) 

Does your dataset agree? Are American champagnes rated as highly (on average) as French champagnes?[^hint-ahh-the-french-champagne]

```{r}
wines %>%
  filter(country == "France" | country == "US") %>%
  filter(variety == "Champagne Blend") %>%
  ggplot(aes(x=points, y=country, fill=country)) + 
  geom_violin(draw_quantiles=.5) + 
  ggtitle("French wines are better on the whole...")
```

## 1.5 **challenge**

What are the two most common `variety` of wine in each country?

```{r}
wines %>% group_by(country, variety) %>%
  summarize(count = n()) %>%
  arrange(desc(count)) %>%
  summarize(variety = head(variety, 2))
```
# 2 Who has the best wine? 

Fit a standard linear model predicting `points` using `country`. According to this model, which country has the most highly rated wines? Is this significant?

```{r}
quality_model = lm(points ~ 0 + country, data=wines)
broom::tidy(quality_model, conf.int=T) %>% 
  mutate(term = fct_reorder(as.factor(term), estimate))%>%
  ggplot(aes(x=estimate, y=term, xmin=conf.low, xmax=conf.high, height=.1)) + 
  geom_errorbarh() + geom_point()
```

*France is best, and Italy, while close, is still clearly worse on average!*

# 3 What is the relationship between price and quality? 
Look at the plot showing the relationship between price and quality for each country in the data.
```{r fig.width=8, fig.height=3, fig.fullwidth=T}
ggplot(wines, aes(x=points, y=price)) + 
  geom_point(alpha=.5, lwd=0) + 
  geom_smooth(method=lm) + 
  facet_grid(~country) 
```


## 3.1

From the scatterplot above, does the relationship between price and rating appear to be constant over countries? Does the relationship appear to be linear? 

*It looks nonlinear, as well as varying by country.*

## 3.2

Fit a multilevel model predicting the `price` using `points` that allows the slope and intercept to vary by `country`.[^hint-centering] 

```{r}
library(lme4)
countries = lmer(price ~ 1 + points + (1 + points | country),
                 data=wines %>% 
                   mutate(points = points - mean(points)))
```

## 3.2.1

In the model from 3.2, which country has the lowest baseline price for an average-rated wine? Is it statistically significantly different from the other countries? Briefly interpret what this means in real world terms. 

*Yes! Chile is cheap, and unusually so.*
```{r}
lattice::dotplot(ranef(countries))
```


### 3.2.2

In the model from 3.2, which country pays the highest "premium" for higher-rated wine?[^hint-premium] Is this statistically significantly different from the other countries? Briefly interpret what this means in real world terms. 

*Yes! French wines make you pay way more for quality!*
```{r}
lattice::dotplot(ranef(countries))
```

## 3.3

Given your interpretations from Section 3.2, is French wine higher quality, or just overpriced?[^shades-of-red]

## 3.4 **Challenge**

Your friend says they bought a 100-point wine for about $70, but are not sure where it is from. 

You use your model model to predict the price of a 100-point wine in every country[^hint-centering2], and find that it might have come from one of two countries. Given what you have done in Section 1 and here, which country do you think is more likely and why? 

```{r}
scenario = data.frame(country = unique(wines$country), 
                              points=100-mean(wines$points))
scenario %>% 
  mutate(prediction = predict(countries, scenario)) %>%
  arrange(prediction) %>%
  knitr::kable()
```

*It's either from Chile or the US. Given the fact that **no wine in our dataset** scored over 95 from Chile, it's probably from the US.* 

# 4 Can we predict where a wine comes from?

Using logistic regression...

## 4.1 

Fit a model predicting whether a wine is from France using the wine's price and rating. In this model, 

```{r}
is_french = glm(country == "France" ~ price + points, 
                data=wines, family=binomial())
summary(is_french)
```

### 4.1.1

Do more expensive wines tend to be from France? 

*Yes! The effect of `price` is significant and positive.*

### 4.1.2 

Do more highly-rated wines tend to be from France? '

*Yes! The effect of `points` is significant and positive.*

### 4.1.3

Using a cutoff of .2, show me the confusion matrix. How many French wines does our model classify correctly?


```{r}
wines %>% mutate(predict_p = predict(is_french, type='response'), 
                 is_French = country == "France") %>%
  mutate(predict_French = predict_p > .2) %>%
  xtabs(~ predict_French + is_French, data=.)
```
This question asks for the sensitivity. This is very bad in our model: `r round(1413/(13372 + 1413), 2)`.

## 4.2

Now, fit a model predicting whether or not a wine is from the United States using the wine's price and rating. In this model, [^interp-help] 

```{r}
is_US = glm(country == "US" ~ price + points, 
                data=wines, family=binomial())
summary(is_US)
```

### 4.2.1

Do more expensive wines tend to be from the US? 

*No! In fact, price is negatively associated with being a US wine!*

### 4.2.2 

Do more highly-rated wines tend to be from the US? [^interp-help2]


*No! Rating is not significantly associated with being a US wine.*

## 4.3 **Challenge**

At what threshold is the accuracy maximized in each model? 

Which model can attain the highest accuracy: the model predicting French wine, or the model predicting American wine? 

```{r}

acc <- function(threshold, model=is_france, 
                     target="France", data=wines){
  outcome = data %>% mutate(predict_p = predict(model, type='response'),
                  outcome = (country == target)) %>%
    mutate(predict_b = predict_p > threshold)
  right = outcome %>% filter(outcome == predict_b) %>% nrow()
  
  return(right/nrow(outcome))
}

score_us <- c()
score_france <- c()

for(threshold in seq(0,1,.01)){
  score_us <- c(score_us, acc(threshold, 
                          model=is_US, 
                          target='US'))
  score_france <- c(score_france, acc(threshold, 
                                  model=is_french,
                                  target="France"))
}

ggplot(mapping=aes(x=seq(0,1,.01))) +
  geom_line(mapping=aes(y=score_us), color='red') + 
  geom_line(mapping=aes(y=score_france), color='blue') + 
  xlabel('Threshold') + ylabel('Accuracy')
```
The best accuracy for the US model happens around a threshold of .54. 

The best accuracy for the French model happens at .39, but gets there at around .25. 

[^hint-ahh-the-french-champagne]: Remember: the `variety` column contains the kind of grape that made the wine. And, most Champagne wines are actually `Champagne Blend`, when you're as pedantic as the typical *WineMag* reader `r emo::ji('grin')`
[^hint-centering]: Remember to center your X variables when running multilevel models! This improves the numerical stability of the estimating algorithms, and makes it easier to interpret $\alpha$ as "the mean of $y$ when $x$ is at its mean."
[^hint-centering2]: Remember that you may have centered your variables! 100 points is *not* the same as 100 points above the mean rating! 
[^hint-premium]: Another way of phrasing this is: which country's prices rise the fastest for each point of rating? Who's over-charging? 
[^interp-help]: To help give a grounded, real-world interpretation, compare these results to our model predicting French wine in 3.1 when answering the following questions.
[^shades-of-red]: It's also ok if the true answer is somewhere in between!